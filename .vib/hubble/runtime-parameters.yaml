tls:
  enabled: true
  autoGenerated:
    enabled: true
    engine: helm
ui:
  replicaCount: 2
  enabled: true
  service:
    ports:
      http: 80
    type: LoadBalancer
  serviceAccount:
    create: true
  podSecurityContext:
    enabled: true
    fsGroup: 1002
  backend:
    containerSecurityContext:
      enabled: true
      runAsUser: 1002
  frontend:
    containerSecurityContext:
      enabled: true
      runAsUser: 1002
relay:
  replicaCount: 1
  serviceAccount:
    create: true
  podSecurityContext:
    enabled: true
    fsGroup: 1002
  containerSecurityContext:
    enabled: true
    runAsUser: 1002
  # required to act as server peer
  sidecars:
  - name: cilium
    image: bitnami/cilium:latest
    imagePullPolicy: IfNotPresent
    securityContext:
      runAsUser: 0
      privileged: true
    ports:
      - name: http
        containerPort: 4244
    command:
      - cilium-agent
    args:
      - --lib-dir
      - /opt/bitnami/cilium/var/lib
      - --state-dir
      - /opt/bitnami/cilium/var/run
      - --enable-hubble
      - --hubble-listen-address
      - ":4244"
      - --hubble-disable-tls
serverPeers:
  host: localhost
  port: 4244
# Required RBAC rules for cilium-agent sidecar
extraDeploy:
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cilium-agent
    rules:
      - apiGroups:
          - networking.k8s.io
        resources:
          - networkpolicies
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - discovery.k8s.io
        resources:
          - endpointslices
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - namespaces
          - services
          - pods
          - endpoints
          - nodes
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - events
        verbs:
          - create
          - patch
      - apiGroups:
          - ""
        resources:
          - nodes/status
        verbs:
          - patch
      - apiGroups:
          - coordination.k8s.io
        resources:
          - leases
        verbs:
          - create
          - get
          - update
          - list
          - delete
      - apiGroups:
          - apiextensions.k8s.io
        resources:
          - customresourcedefinitions
        verbs:
          - list
          - watch
          - get
      - apiGroups:
          - cilium.io
        resources:
          - ciliumloadbalancerippools
          - ciliumbgppeeringpolicies
          - ciliumbgpnodeconfigs
          - ciliumbgpadvertisements
          - ciliumbgppeerconfigs
          - ciliumclusterwideenvoyconfigs
          - ciliumclusterwidenetworkpolicies
          - ciliumegressgatewaypolicies
          - ciliumendpoints
          - ciliumendpointslices
          - ciliumenvoyconfigs
          - ciliumidentities
          - ciliumlocalredirectpolicies
          - ciliumnetworkpolicies
          - ciliumnodes
          - ciliumnodeconfigs
          - ciliumcidrgroups
          - ciliuml2announcementpolicies
          - ciliumpodippools
        verbs:
          - list
          - watch
      - apiGroups:
          - cilium.io
        resources:
          - ciliumidentities
          - ciliumendpoints
          - ciliumnodes
        verbs:
          - create
      - apiGroups:
          - cilium.io
        resources:
          - ciliumidentities
        verbs:
          - update
      - apiGroups:
          - cilium.io
        resources:
          - ciliumendpoints
        verbs:
          - delete
          - get
      - apiGroups:
          - cilium.io
        resources:
          - ciliumnodes
          - ciliumnodes/status
        verbs:
          - get
          - update
      - apiGroups:
          - cilium.io
        resources:
          - ciliumnetworkpolicies/status
          - ciliumclusterwidenetworkpolicies/status
          - ciliumendpoints/status
          - ciliumendpoints
          - ciliuml2announcementpolicies/status
          - ciliumbgpnodeconfigs/status
        verbs:
          - patch
  - kind: ClusterRoleBinding
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
      name: cilium-agent
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cilium-agent
    subjects:
      - kind: ServiceAccount
        name: "{{ template \"hubble.relay.serviceAccountName\" . }}"
        namespace: "{{ include \"common.names.namespace\" . }}"
