{{- /*
Copyright VMware, Inc.
SPDX-License-Identifier: APACHE-2.0
*/}}

{{- if .Values.grafana.enabled }}
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: {{ printf "%s-grafana" (include "common.names.fullname" .) | trunc 63 | trimSuffix "-" }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" . | nindent 4 }}
    {{- if .Values.commonLabels }}
    {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 4 }}
    {{- end }}
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
spec:
  client:
    timeout: {{ .Values.grafana.client.timeout }}
  {{- if .Values.grafana.persistence.enabled }}
  dataStorage:
    labels: {{- include "common.labels.standard" . | nindent 6 }}
      {{- if .Values.commonLabels }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 6 }}
      {{- end }}
    {{- if or .Values.commonAnnotations .Values.grafana.persistence.annotations }}
    annotations:
      {{- if .Values.commonAnnotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
      {{- end }}
      {{- if .Values.grafana.persistence.annotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.persistence.annotations "context" $ ) | nindent 6 }}
      {{- end }}
    {{- end }}
    accessModes:
      {{- range .Values.grafana.persistence.accessModes }}
        - {{ . | quote }}
      {{- end }}
    size: {{ .Values.grafana.persistence.size }}
    {{- if .Values.grafana.persistence.existingVolume }}
    volumeName: {{ .Values.grafana.persistence.existingVolume }}
    {{- end }}
    {{- if .Values.grafana.persistence.storageClass }}
    class: {{ .Values.grafana.persistence.storageClass }}
    {{- end }}
  {{- end }}
  service:
    {{- if or .Values.commonAnnotations .Values.grafana.service.annotations }}
    annotations:
      {{- if .Values.grafana.service.annotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.service.annotations "context" $) | nindent 6 }}
      {{- end }}
      {{- if .Values.commonAnnotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
      {{- end }}
    {{- end }}
  {{- $imagePullSecrets := include "common.images.pullSecrets" (dict "images" (list .Values.operator.image .Values.grafana.image .Values.grafana.pluginsInitContainerImage) "global" .Values.global) }}
  {{- if (not (empty ($imagePullSecrets))) | or .Values.grafana.serviceAccount }}
  serviceAccount:
  {{- with .Values.grafana.serviceAccount }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- $imagePullSecrets | nindent 4 }}
  {{- end }}
  {{- if .Values.grafana.sidecars }}
  containers:
    {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.sidecars "context" $) | nindent 4 }}
  {{- end }}
  deployment:
    {{- if .Values.commonAnnotations }}
    annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.envFrom }}
    envFrom: {{- include "common.tplvalues.render" (dict "value" .Values.grafana.envFrom "context" $ ) | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.tolerations }}
    tolerations: {{- include "common.tplvalues.render" (dict "value" .Values.grafana.tolerations "context" $) | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.nodeSelector }}
    nodeSelector: {{ toYaml .Values.grafana.nodeSelector | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.updateStrategy }}
    strategy: {{ toYaml .Values.grafana.updateStrategy | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.extraVolumeMounts }}
    extraVolumeMounts:
      {{- include "common.tplvalues.render" (dict "value" .Values.grafana.extraVolumeMounts "context" $) | nindent 6 }}
    {{- end }}
    {{- if .Values.grafana.extraVolumes }}
    extraVolumes:
      {{- include "common.tplvalues.render" (dict "value" .Values.grafana.extraVolumes "context" $) | nindent 6 }}
    {{- end }}
  ingress:
    # enabled: {{ .Values.grafana.ingress.enabled }}
    {{- if and .Values.grafana.ingress.ingressClassName (include "common.ingress.supportsIngressClassname" .) }}
    ingressClassName: {{ .Values.grafana.ingress.ingressClassName | quote }}
    {{- end }}
    {{- if or .Values.commonLabels .Values.grafana.ingress.labels }}
    labels:
      {{- if .Values.commonLabels }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 6 }}
      {{- end }}
      {{- if .Values.grafana.labels }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.labels "context" $ ) | nindent 6 }}
      {{- end }}
      {{- if .Values.grafana.ingress.labels }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.ingress.labels "context" $ ) | nindent 6 }}
      {{- end }}
    {{- end }}
    {{- if or .Values.commonAnnotations .Values.grafana.ingress.annotations }}
    annotations:
      {{- if .Values.commonAnnotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
      {{- end }}
      {{- if .Values.grafana.ingress.annotations }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.ingress.annotations "context" $ ) | nindent 6 }}
      {{- end }}
    {{- end }}
  config: {{- include "common.tplvalues.render" ( dict "value" .Values.grafana.config "context" $ ) | nindent 4 }}
  {{- if .Values.grafana.configMaps }}
  configMaps: {{ toYaml .Values.grafana.configMaps | nindent 4 }}
  {{- end }}
  {{- if .Values.grafana.secrets }}
  secrets: {{ toYaml .Values.grafana.secrets | nindent 4 }}
  {{- end }}
  {{- if .Values.grafana.dashboardNamespaceSelector }}
  dashboardNamespaceSelector: {{- include "common.tplvalues.render" (dict "value" .Values.grafana.dashboardNamespaceSelector "context" $ ) | nindent 4 }}
  {{- end }}
  jsonnet:
    libraryLabelSelector: {{- include "common.tplvalues.render" (dict "value" .Values.grafana.jsonnetLibrarySelector "context" $ ) | nindent 6 }}
{{- end }}
