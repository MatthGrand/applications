{{- if .Values.provisioning.enabled }}
kind: Job
apiVersion: batch/v1
metadata:
  name: {{ include "kafka.fullname" . }}-provisioning
  labels:
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  template:
    metadata:
      labels:
      annotations:
    spec:
      restartPolicy: OnFailure
      terminationGracePeriodSeconds: 0
      containers:
      - name: kafka-provisioning
        image: {{ include "kafka.provisioning.image" . }}
        imagePullPolicy: {{ .Values.provisioning.image.pullPolicy | quote }}
        command:
        - /bin/bash
        - -c
        - >-
        {{- $bootstrapServer := printf "%s:%d" (include "kafka.fullname" .) (.Values.service.port | int64) }}
        {{- range $topic := .Values.provisioning.topics }}
          /opt/bitnami/kafka/bin/kafka-topics.sh \
            --create \
            --if-not-exists \
            --bootstrap-server {{ $bootstrapServer }} \
            --replication-factor {{ $topic.replicationFactor }} \
            --partitions {{ $topic.partitions }} \
            {{- range $name, $value := $topic.config }}
            --config {{ $name }}={{ $value }} \
            {{- end }}
            --topic {{ $topic.name }};
        {{- end }}
        env:
        - name: BITNAMI_DEBUG
          value: {{ ternary "true" "false" .Values.provisioning.image.debug | quote }}
{{- end }}
