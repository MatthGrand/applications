---
# Source: airflow/templates/worker/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: airflow-worker
  labels:
    app.kubernetes.io/name: airflow
    helm.sh/chart: airflow-7.0.0
    app.kubernetes.io/instance: airflow
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: worker
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: airflow
      app.kubernetes.io/instance: airflow
      app.kubernetes.io/component: worker
  serviceName: airflow-worker-headless
  replicas: 1
  updateStrategy:
    type: 'RollingUpdate'
  template:
    metadata:
      labels:
        app.kubernetes.io/name: airflow
        helm.sh/chart: airflow-7.0.0
        app.kubernetes.io/instance: airflow
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: worker
    spec:
      securityContext:
        fsGroup: 1001
        runAsUser: 1001
      serviceAccountName: default
      affinity:
        podAffinity:

        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: airflow
                    app.kubernetes.io/instance: airflow
                    app.kubernetes.io/component: worker
                namespaces:
                  - default
                topologyKey: kubernetes.io/hostname
              weight: 1
        nodeAffinity:

      initContainers:
        - name: clone-repositories
          image: 'docker.io/bitnami/git:2.29.0-debian-10-r0'
          imagePullPolicy: 'IfNotPresent'
          command:
            - echo
            - hello
          volumeMounts:
            - name: git-cloned-dag-files-github.com-darteaga
              mountPath: /dags-github.com-darteaga
      containers:
        - name: sync-repositories
          image: 'docker.io/bitnami/git:2.29.0-debian-10-r0'
          imagePullPolicy: 'IfNotPresent'
          command:
            - /bin/bash
            - -ec
            - |
              while true; do
                  cd /dags-github.com-darteaga && git pull origin master
                  sleep 60
              done
          volumeMounts:
            - name: git-cloned-dag-files-github.com-darteaga
              mountPath: /dags-github.com-darteaga
        - name: airflow-worker
          image: docker.io/bitnami/airflow-worker:1.10.12-debian-10-r47
          imagePullPolicy: 'IfNotPresent'
          resources:
            limits: {}
            requests: {}
          env:
            - name: AIRFLOW_EXECUTOR
              value: 'CeleryExecutor'
            - name: AIRFLOW_FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflow
                  key: airflow-fernetKey
            - name: AIRFLOW_WEBSERVER_HOST
              value: airflow
            - name: AIRFLOW_WEBSERVER_PORT_NUMBER
              value: '8080'
            - name: AIRFLOW_LOAD_EXAMPLES
              value: 'no'
            - name: AIRFLOW_DATABASE_NAME
              value: 'bitnami_airflow'
            - name: AIRFLOW_DATABASE_USERNAME
              value: 'bn_airflow'
            - name: AIRFLOW_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: airflow-postgresql
                  key: postgresql-password
            - name: AIRFLOW_DATABASE_HOST
              value: 'airflow-postgresql'
            - name: AIRFLOW_DATABASE_PORT_NUMBER
              value: '5432'
            - name: REDIS_HOST
              value: 'airflow-redis-master'
            - name: REDIS_PORT_NUMBER
              value: '6379'
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: airflow-redis
                  key: redis-password
          envFrom:
          ports:
            - name: worker
              containerPort: 8793
          livenessProbe:
            tcpSocket:
              port: worker
            initialDelaySeconds: 180
            periodSeconds: 20
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          readinessProbe:
            tcpSocket:
              port: worker
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          volumeMounts:
            - name: git-cloned-dag-files-github.com-darteaga
              mountPath: /opt/bitnami/airflow/dags/git-github.com-darteaga
      volumes:
        - name: git-cloned-dag-files-github.com-darteaga
          emptyDir: {}
